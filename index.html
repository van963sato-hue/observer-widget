<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0b0c10" />
<title>è¦³æ¸¬è€…ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ PWA â€” Prototype</title>
<link rel="manifest" href="#manifest-placeholder" id="manifest-link">
<style>
:root{
  --bg:#0b0c10;--card:#12141a;--muted:#9aa6b2;--hi:#ff7b54;--ok:#5bffa5;--fg:#e9eef5;--accent:#ffb020;--warning:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%;}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
.container{max-width:420px;margin:0 auto;padding:12px}
.widget{position:relative;width:100%;aspect-ratio:1/1;border-radius:20px;border:1px solid #232632;overflow:hidden;background:linear-gradient(180deg,#141822,#0b0e15)}
.header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#0e1118}
.badge{font-size:12px;border:1px solid #2a3142;border-radius:999px;padding:2px 8px;color:#bcd2ff;background:#0d1a2b}
.sprite{position:absolute;inset:0;display:grid;place-items:center}
.sprite img{max-width:80%;max-height:80%;image-rendering:pixelated}
.hud{position:absolute;left:8px;bottom:8px;display:flex;gap:6px;flex-wrap:wrap}
.pill{display:inline-flex;gap:6px;align-items:center;background:#101420;border:1px solid #232632;border-radius:999px;padding:4px 8px}
.pill b{color:#a8ffcf}
.btn-main{position:absolute;right:10px;bottom:10px;background:#151a26;border:1px solid #2a3142;color:var(--fg);border-radius:14px;padding:8px 12px;cursor:pointer}
.btn-main:active{transform:translateY(1px)}
.menu{position:absolute;inset:0;display:none;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.65));backdrop-filter:blur(2px)}
.menu.show{display:grid;place-items:center}
.grid{display:grid;grid-template-columns:repeat(3,94px);gap:8px}
.tile{background:#0f1320;border:1px solid #2a3142;border-radius:14px;width:94px;height:94px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:6px}
.tile small{color:var(--muted);font-size:11px}
.tile:active{transform:translateY(1px)}
.footer{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.small{font-size:12px;color:var(--muted)}
hr{border:0;border-top:1px dashed #2a3142;margin:12px 0}
.hidden{display:none}
/* panels */
.panel{border:1px solid #232632;border-radius:14px;padding:10px;background:#0f121a}
.panel h3{margin:0 0 6px 0;font-size:14px}
input[type="text"], input[type="time"], textarea{width:100%;background:#0b0e15;border:1px solid #202636;color:var(--fg);border-radius:10px;padding:8px}
button{background:#171c28;border:1px solid #2a3142;color:#e9eef5;padding:8px 10px;border-radius:10px;cursor:pointer}
button.ghost{background:transparent}
button.ok{background:#0d1f17;border-color:#2e664a}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.list{list-style:none;margin:8px 0 0;padding:0}
.list li{display:flex;justify-content:space-between;gap:8px;padding:6px 8px;border:1px solid #232632;border-radius:10px}
.canvas-wrap{display:grid;place-items:center;background:#0b0e15;border:1px dashed #2a3142;border-radius:12px;padding:8px}
canvas{max-width:100%}
kbd{background:#1b1f2a;border:1px solid #2a3142;padding:2px 6px;border-radius:6px;font-family:ui-monospace, SFMono-Regular, Consolas, Menlo, Monaco, monospace;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="row">
      <span class="badge">è¦³æ¸¬è€…ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ</span>
    </div>
    <div class="row small">
      <span id="charName">â€”</span>
      <button id="switchBtn" class="ghost" title="ã‚­ãƒ£ãƒ©åˆ‡æ›¿">åˆ‡æ›¿</button>
    </div>
  </div>

  <div class="widget" id="widget">
    <div class="sprite" id="sprite"><img id="gif" alt="sprite"></div>
    <div class="hud" id="hud">
      <div class="pill">â¤ï¸<b id="love">0</b></div>
      <div class="pill">ğŸª <b id="hunger">100</b></div>
      <div class="pill">ğŸ’¤ <b id="energy">100</b></div>
    </div>
    <button class="btn-main" id="menuBtn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
    <div class="menu" id="menu">
      <div class="grid">
        <div class="tile" data-open="weather"><div>â›…ï¸</div><small>å¤©æ°—</small></div>
        <div class="tile" data-open="postcard"><div>ğŸ–¼ï¸</div><small>ã‚¹ã‚¯ã‚·ãƒ§</small></div>
        <div class="tile" data-open="alarm"><div>â°</div><small>ç›®è¦šã¾ã—</small></div>
        <div class="tile" data-open="todo"><div>âœ…</div><small>ToDo</small></div>
        <div class="tile" data-open="memo"><div>ğŸ“</div><small>ãƒ¡ãƒ¢</small></div>
        <div class="tile" data-open="news"><div>ğŸ“°</div><small>ãƒ‹ãƒ¥ãƒ¼ã‚¹</small></div>
        <div class="tile" data-open="rpg"><div>âš”ï¸</div><small>è¦³æ¸¬RPG</small></div>
        <div class="tile" data-open="puyo"><div>ğŸ”·</div><small>è¦³æ¸¬ã·ã‚ˆ</small></div>
        <div class="tile" data-action="feed"><div>ğŸª</div><small>ãŠã‚„ã¤</small></div>
      </div>
    </div>
  </div>

  <div class="footer small">
    <span>ãƒ’ãƒ³ãƒˆï¼šã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã§â™¥ä¸Šæ˜‡ã€‚<kbd>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </kbd>ã§PWAåŒ–ã€‚</span>
  </div>

  <div id="panels">
    <!-- Weather Panel -->
    <section class="panel hidden" id="panel-weather">
      <h3>â›…ï¸ å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h3>
      <div class="row"><button id="btnWeather">å–å¾—</button><span class="small">Openâ€‘Meteoä½¿ç”¨ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰</span></div>
      <pre id="weatherOut" class="small">æœªå–å¾—</pre>
    </section>

    <!-- Postcard/Screenshot Panel -->
    <section class="panel hidden" id="panel-postcard">
      <h3>ğŸ–¼ï¸ ã‚¹ã‚¯ã‚·ãƒ§ï¼ˆãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ç”Ÿæˆï¼‰</h3>
      <div class="canvas-wrap"><canvas id="shot" width="640" height="640"></canvas></div>
      <div class="row" style="margin-top:8px"><button id="btnShot">ç”Ÿæˆ</button><a id="dlShot" download="observer_postcard.png"><button class="ok">ä¿å­˜</button></a></div>
      <div class="small">â€»ç«¯æœ«ã®ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã§ã¯ãªãã€ã“ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®çŠ¶æ…‹ã‚’åˆæˆã—ã¾ã™ã€‚</div>
    </section>

    <!-- Alarm Panel -->
    <section class="panel hidden" id="panel-alarm">
      <h3>â° ç›®è¦šã¾ã—</h3>
      <div class="row">
        <input type="time" id="alarmTime"> <button id="addAlarm">è¿½åŠ </button> <button id="testAlarm" class="ghost">é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
      </div>
      <ul id="alarms" class="list"></ul>
      <div class="small">é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹ã¨ã€æŒ‡å®šæ™‚åˆ»ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œï¼‰ã€‚</div>
    </section>

    <!-- Todo Panel -->
    <section class="panel hidden" id="panel-todo">
      <h3>âœ… ToDo</h3>
      <div class="row"><input type="text" id="todoText" placeholder="ã‚„ã‚‹ã“ã¨â€¦"><button id="addTodo">è¿½åŠ </button></div>
      <ul id="todoList" class="list"></ul>
    </section>

    <!-- Memo Panel -->
    <section class="panel hidden" id="panel-memo">
      <h3>ğŸ“ ãƒ¡ãƒ¢å¸³</h3>
      <textarea id="memo" rows="6" placeholder="è‡ªç”±ãƒ¡ãƒ¢"></textarea>
      <div class="row" style="margin-top:8px"><button id="saveMemo" class="ok">ä¿å­˜</button><span class="small" id="memoSaved"> </span></div>
    </section>

    <!-- News Panel -->
    <section class="panel hidden" id="panel-news">
      <h3>ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹</h3>
      <div class="row small">
        <span>RSS/JSON URLï¼š</span><input type="text" id="newsUrl" placeholder="https://example.com/feed.xml">
        <button id="loadNews">èª­è¾¼</button>
      </div>
      <ul id="newsList" class="list"></ul>
      <div class="small">â€»CORSåˆ¶é™æ™‚ã¯åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šè‡ªå‰Cloudflare Workerï¼‰ã€‚</div>
    </section>

    <!-- RPG Panel -->
    <section class="panel hidden" id="panel-rpg">
      <h3>âš”ï¸ è¦³æ¸¬ãƒã‚¯ã‚¹ãƒ©RPGï¼ˆè¶…ãƒŸãƒ‹ï¼‰</h3>
      <div id="rpgBox" class="small"></div>
      <div class="row" style="margin-top:8px">
        <button id="rpgFight">æ¢ç´¢</button>
        <button id="rpgHeal" class="ghost">ä¼‘ã‚€</button>
        <span id="rpgMsg" class="small"></span>
      </div>
    </section>

    <!-- Puyo Panel -->
    <section class="panel hidden" id="panel-puyo">
      <h3>ğŸ”· è¦³æ¸¬ã·ã‚ˆï¼ˆç°¡æ˜“ç‰ˆï¼‰</h3>
      <div class="canvas-wrap"><canvas id="puyo" width="240" height="480"></canvas></div>
      <div class="row small" style="margin-top:8px">
        <span>æ“ä½œï¼šâ† â†’ ã§ç§»å‹•ã€â†‘ å›è»¢ã€â†“ è½ä¸‹</span>
        <button id="puyoStart">é–‹å§‹</button>
      </div>
    </section>
  </div>
</div>

<script>
// ---------------------------
// ã‚­ãƒ£ãƒ©è¨­å®šï¼ˆå·®ã—æ›¿ãˆOKï¼‰
// ---------------------------
const CHARACTERS = [
  { id:'kamil', name:'ã‚«ãƒŸãƒ«', gif:'assets/kamil_chibi.gif' },
  { id:'skuda', name:'ã‚¹ã‚¯ãƒ¼ãƒ€', gif:'assets/skuda_chibi.gif' },
  { id:'yuu',   name:'ãƒ¦ã‚¦',   gif:'assets/yuu_chibi.gif' },
  { id:'ryo',   name:'ãƒªãƒ§ã‚¦', gif:'assets/ryo_chibi.gif' },
  { id:'level', name:'ãƒ¬ãƒ´ã‚§ãƒ«', gif:'assets/level_chibi.gif' }
];

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµµæ–‡å­—ï¼ˆGIFæœªé…ç½®æ™‚ï¼‰
const FALLBACK_EMOJI = {kamil:'ğŸª½', skuda:'ğŸ¦‡', yuu:'ğŸ¦…', ryo:'ğŸº', level:'ğŸ‰'};

// çŠ¶æ…‹
const state = {
  idx: +localStorage.getItem('obs.char.idx') || 0,
  love: +localStorage.getItem('obs.love') || 0,
  hunger: +localStorage.getItem('obs.hunger') || 100,
  energy: +localStorage.getItem('obs.energy') || 100
};

// è¦ç´ 
const el = (id)=>document.getElementById(id);
const gif = el('gif');

function saveVital(){
  localStorage.setItem('obs.love', state.love);
  localStorage.setItem('obs.hunger', state.hunger);
  localStorage.setItem('obs.energy', state.energy);
}

function renderChar(){
  const c = CHARACTERS[state.idx % CHARACTERS.length];
  el('charName').textContent = c.name;
  localStorage.setItem('obs.char.idx', state.idx);
  // try load gif, else fallback
  gif.src = c.gif;
  gif.onerror = ()=>{ gif.onerror=null; gif.removeAttribute('src'); gif.alt=c.name; gif.replaceWith(Object.assign(document.createElement('div'),{textContent:FALLBACK_EMOJI[c.id]||'â­',style:'font-size:96px'})); };
  renderVitals();
}

function renderVitals(){
  el('love').textContent = state.love;
  el('hunger').textContent = state.hunger;
  el('energy').textContent = state.energy;
}

// ã‚¿ãƒƒãƒ—ã§ãªã¤ãåº¦UP / æ¶ˆè²»
el('widget').addEventListener('click', (ev)=>{
  if (ev.target.closest('#menu')) return; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯åˆ¥
  state.love += 1;
  state.hunger = Math.max(0, state.hunger-1);
  state.energy = Math.max(0, state.energy-1);
  saveVital();
  renderVitals();
});

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡
const menu = el('menu');
const menuBtn = el('menuBtn');
menuBtn.onclick = ()=> menu.classList.toggle('show');
menu.addEventListener('click',(e)=>{
  const t = e.target.closest('.tile'); if(!t) return;
  const open = t.dataset.open; const act=t.dataset.action;
  if (open) openPanel(open);
  if (act==='feed'){ state.hunger = Math.min(100, state.hunger+10); saveVital(); renderVitals(); }
  menu.classList.remove('show');
});

function openPanel(name){
  document.querySelectorAll('#panels .panel').forEach(p=>p.classList.add('hidden'));
  const p = el('panel-'+name);
  if (p) p.classList.remove('hidden');
}

// ã‚­ãƒ£ãƒ©åˆ‡æ›¿
el('switchBtn').onclick = ()=>{ state.idx=(state.idx+1)%CHARACTERS.length; renderChar(); };

renderChar();

// ---------------------------
// å¤©æ°—ï¼šOpenâ€‘Meteoï¼ˆAPIä¸è¦ï¼‰
// ---------------------------
async function fetchWeather(){
  const out = el('weatherOut');
  out.textContent = 'æ¸¬ä½ä¸­â€¦';
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    try{
      const {latitude:lat, longitude:lon} = pos.coords;
      out.textContent = 'å–å¾—ä¸­â€¦';
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&timezone=auto`;
      const r = await fetch(url);
      const j = await r.json();
      const c = j.current || {};
      out.textContent = `æ°—æ¸©: ${c.temperature_2m}Â°C\nå¤©å€™ã‚³ãƒ¼ãƒ‰: ${c.weather_code}\né¢¨é€Ÿ: ${c.wind_speed_10m} m/s`;
    }catch(e){ out.textContent = 'å–å¾—å¤±æ•—: '+e.message; }
  }, (err)=>{ out.textContent='æ¸¬ä½å¤±æ•—: '+err.message; });
}

el('btnWeather').onclick = fetchWeather;

// ---------------------------
// ã‚¹ã‚¯ã‚·ãƒ§ï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰
// ---------------------------
function drawPostcard(){
  const c = el('shot'); const g = c.getContext('2d');
  g.fillStyle = '#101420'; g.fillRect(0,0,c.width,c.height);
  // frame
  g.strokeStyle = '#2a3142'; g.lineWidth=8; g.strokeRect(8,8,c.width-16,c.height-16);
  // sprite
  const img = document.querySelector('.sprite img, .sprite div');
  return new Promise((resolve)=>{
    if (img && img.tagName==='IMG' && img.complete){
      g.drawImage(img, c.width*0.1, c.height*0.1, c.width*0.8, c.height*0.8);
      overlay(); resolve();
    } else {
      // fallback: emoji/text
      g.fillStyle='#e9eef5'; g.font='bold 160px system-ui'; g.textAlign='center'; g.fillText(img?.textContent||'â­', c.width/2, c.height*0.6);
      overlay(); resolve();
    }
    function overlay(){
      g.fillStyle='rgba(0,0,0,.4)'; g.fillRect(0,c.height-120,c.width,120);
      g.fillStyle='#e9eef5'; g.font='20px system-ui';
      const now = new Date();
      g.fillText(now.toLocaleString(), 24, c.height-80);
      g.fillText(`â¤${state.love} ğŸª${state.hunger} ğŸ’¤${state.energy}`, 24, c.height-48);
      g.textAlign='right';
      g.fillText(CHARACTERS[state.idx].name, c.width-24, c.height-48);
    }
  });
}

el('btnShot').onclick = async()=>{ await drawPostcard(); el('dlShot').href = el('shot').toDataURL('image/png'); };

// ---------------------------
// ç›®è¦šã¾ã—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ï¼‰
// ---------------------------
const ALARM_KEY = 'obs.alarms.v1';
function getAlarms(){ return JSON.parse(localStorage.getItem(ALARM_KEY)||'[]'); }
function setAlarms(a){ localStorage.setItem(ALARM_KEY, JSON.stringify(a)); renderAlarms(); }

async function ensureNotify(){
  if (!('Notification' in window)) return false;
  if (Notification.permission==='granted') return true;
  const p = await Notification.requestPermission(); return p==='granted';
}

function renderAlarms(){
  const ul = el('alarms'); ul.innerHTML='';
  getAlarms().forEach((t,i)=>{
    const li = document.createElement('li');
    li.innerHTML = `<span>â° ${t}</span>`;
    const b = document.createElement('button'); b.textContent='å‰Šé™¤'; b.onclick=()=>{ const a=getAlarms(); a.splice(i,1); setAlarms(a); };
    li.appendChild(b); ul.appendChild(li);
  });
}

el('addAlarm').onclick = async()=>{
  const v = el('alarmTime').value; if(!v) return;
  if (!await ensureNotify()) alert('é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
  const a = getArmsSafe(); a.push(v); setAlarms(a);
};
function getArmsSafe(){ try{return getAlarms();}catch{ return []; } }

el('testAlarm').onclick = async()=>{ if(await ensureNotify()) new Notification('è¦³æ¸¬è€…ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ', {body:'é€šçŸ¥ãƒ†ã‚¹ãƒˆ', icon:''}); };

setInterval(()=>{
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');
  const cur = `${hh}:${mm}`;
  const a = getAlarms();
  if (a.includes(cur)){
    if ('vibrate' in navigator) navigator.vibrate([200,100,200]);
    if ('Notification' in window && Notification.permission==='granted'){
      new Notification('â° ã‚¢ãƒ©ãƒ¼ãƒ ', { body: `${cur}`, tag:'obs-alarm' });
    }
  }
}, 1000*20); // 20ç§’ã”ã¨ç¢ºèªï¼ˆçœé›»åŠ›ï¼‰

renderAlarms();

// ---------------------------
// ToDo & ãƒ¡ãƒ¢
// ---------------------------
function todos(){ return JSON.parse(localStorage.getItem('obs.todos')||'[]'); }
function saveTodos(v){ localStorage.setItem('obs.todos', JSON.stringify(v)); renderTodos(); }
function renderTodos(){ const ul=el('todoList'); ul.innerHTML=''; todos().forEach((t,i)=>{ const li=document.createElement('li'); li.innerHTML=`<span>${t.text}</span>`; const b=document.createElement('button'); b.textContent='å®Œäº†'; b.onclick=()=>{ const a=todos(); a.splice(i,1); saveTodos(a); }; li.appendChild(b); ul.appendChild(li); }); }

el('addTodo').onclick = ()=>{ const v=el('todoText').value.trim(); if(!v) return; const a=todos(); a.push({text:v,ts:Date.now()}); saveTodos(a); el('todoText').value=''; };
renderTodos();

el('saveMemo').onclick = ()=>{ localStorage.setItem('obs.memo', el('memo').value); el('memoSaved').textContent='ä¿å­˜ã—ã¾ã—ãŸ'; setTimeout(()=>el('memoSaved').textContent=' ',1500); };
el('memo').value = localStorage.getItem('obs.memo')||'';

// ---------------------------
// ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆè¶…ç°¡æ˜“ãƒ»URLç›´èª­ï¼‰
// ---------------------------
async function loadNews(){
  const url = el('newsUrl').value.trim();
  const ul = el('newsList'); ul.innerHTML='';
  if(!url){ ul.innerHTML='<li>URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>'; return; }
  try{
    const r = await fetch(url);
    const text = await r.text();
    // RSSï¼ˆXMLï¼‰ã£ã½ã‹ã£ãŸã‚‰é›‘ã«ãƒ‘ãƒ¼ã‚¹
    if (text.trim().startsWith('<')){
      const dom = new DOMParser().parseFromString(text, 'application/xml');
      const items = [...dom.querySelectorAll('item,title')].slice(0,10);
      items.forEach(it=>{
        const title = it.querySelector('title')?.textContent || it.textContent || '(no title)';
        const link = it.querySelector('link')?.textContent || '#';
        const li = document.createElement('li'); li.innerHTML = `<a href="${link}" target="_blank">${title}</a>`; ul.appendChild(li);
      });
    } else {
      // JSONæƒ³å®šï¼š[{title, url}] or {articles:[...]}
      const j = JSON.parse(text);
      const arr = Array.isArray(j)? j : (j.articles||[]);
      arr.slice(0,10).forEach(a=>{ const li=document.createElement('li'); li.innerHTML=`<a href="${a.url||'#'}" target="_blank">${a.title||'(no title)'}</a>`; ul.appendChild(li); });
    }
  }catch(e){ ul.innerHTML = `<li>èª­è¾¼å¤±æ•—: ${e.message}</li>`; }
}

el('loadNews').onclick = loadNews;

// ---------------------------
// è¦³æ¸¬ãƒã‚¯ã‚¹ãƒ©RPGï¼ˆã‚¯ãƒªãƒƒã‚¯æ¢ç´¢ï¼‰
// ---------------------------
const rpg = { hp: +(localStorage.getItem('rpg.hp')||30), atk:1, gold:+(localStorage.getItem('rpg.gold')||0), lv:+(localStorage.getItem('rpg.lv')||1) };
function rpgSave(){ localStorage.setItem('rpg.hp', rpg.hp); localStorage.setItem('rpg.gold', rpg.gold); localStorage.setItem('rpg.lv', rpg.lv); }
function rpgRender(){ el('rpgBox').innerHTML = `HP:${rpg.hp} / LV:${rpg.lv} / ğŸ’°${rpg.gold}`; }
rpgRender();

enl = (id)=>document.getElementById(id);

enl('rpgFight').onclick = ()=>{
  const dmg = 1 + Math.floor(Math.random()* (rpg.lv+1));
  const drop = Math.random() < 0.5 ? 1:0;
  rpg.hp = Math.max(0, rpg.hp - Math.floor(Math.random()*3));
  rpg.gold += drop;
  if (rpg.gold && rpg.gold % 10 === 0){ rpg.lv++; }
  rpgSave(); rpgRender();
  el('rpgMsg').textContent = `æ•µã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ é‡‘è²¨+${drop}`;
};

enl('rpgHeal').onclick = ()=>{ rpg.hp = Math.min(30, rpg.hp+5); rpgSave(); rpgRender(); el('rpgMsg').textContent='ä¼‘æ¯ã—ã¦HPå›å¾©'; };

// ---------------------------
// è¦³æ¸¬ã·ã‚ˆï¼ˆè¶…ç°¡æ˜“ï¼šè½ã¡ç‰© + 4æ¶ˆã—ï¼‰
// ---------------------------
const P = { W:6, H:12, size:40, grid:[], cur:null, timer:null, speed:600, running:false };
const colors = ['#5bc0eb','#fde74c','#9bc53d','#e55934'];
const pc = el('puyo'); const pg = pc.getContext('2d');

function puyoReset(){ P.grid = Array.from({length:P.H},()=>Array(P.W).fill(-1)); P.cur=null; }
function rand(n){ return Math.floor(Math.random()*n); }
function spawn(){ P.cur = { x:2, y:0, pair:[rand(colors.length), rand(colors.length)], rot:0 }; }
function draw(){ pg.clearRect(0,0,pc.width,pc.height); // grid
  for(let y=0;y<P.H;y++) for(let x=0;x<P.W;x++){ const v=P.grid[y][x]; if(v>=0){ pg.fillStyle=colors[v]; pg.fillRect(x*P.size,y*P.size,P.size-1,P.size-1);} }
  if(P.cur){ const [a,b]=curCells(); const col=P.cur.pair; [a,b].forEach((c,i)=>{ pg.fillStyle=colors[col[i]]; pg.fillRect(c.x*P.size,c.y*P.size,P.size-1,P.size-1); }); }
}
function curCells(){ const {x,y,rot}=P.cur; const d=[[0,-1],[1,0],[0,1],[-1,0]][rot%4]; return [{x,y},{x:x+d[0],y:y+d[1]}]; }
function canPlace(cells){ return cells.every(c=> c.x>=0 && c.x<P.W && c.y>=0 && c.y<P.H && P.grid[c.y][c.x]===-1 ); }
function fixToGrid(){ const [a,b]=curCells(); const [ca,cb]=P.cur.pair; if(a.y<0||b.y<0){ gameOver(); return; } P.grid[a.y][a.x]=ca; P.grid[b.y][b.x]=cb; clearMatches(); spawn(); }
function clearMatches(){ const vis=Array.from({length:P.H},()=>Array(P.W).fill(false)); let cleared=false;
  for(let y=0;y<P.H;y++)for(let x=0;x<P.W;x++){ const v=P.grid[y][x]; if(v<0||vis[y][x]) continue; const q=[[x,y]]; vis[y][x]=true; const group=[[x,y]]; while(q.length){ const [cx,cy]=q.pop(); [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{ const nx=cx+dx, ny=cy+dy; if(nx>=0&&nx<P.W&&ny>=0&&ny<P.H&&!vis[ny][nx]&&P.grid[ny][nx]===v){ vis[ny][nx]=true; q.push([nx,ny]); group.push([nx,ny]); }}); }
    if(group.length>=4){ group.forEach(([gx,gy])=>P.grid[gy][gx]=-1); cleared=true; state.love+=group.length; saveVital(); renderVitals(); }
  }
  if(cleared) applyGravity();
}
function applyGravity(){ for(let x=0;x<P.W;x++){ let write=P.H-1; for(let y=P.H-1;y>=0;y--){ if(P.grid[y][x]>=0){ const v=P.grid[y][x]; P.grid[y][x]=-1; P.grid[write][x]=v; write--; } } }
}
function step(){ if(!P.running) return; if(!P.cur) spawn(); const down={...P.cur}; down.y++; if(canPlace(curCells.call({cur:down}))){ P.cur=down; } else { fixToGrid(); }
  draw(); }
function gameOver(){ P.running=false; clearInterval(P.timer); alert('Game Over'); }

document.addEventListener('keydown',(e)=>{
  if(!P.running||!P.cur) return; if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) e.preventDefault();
  if(e.key==='ArrowLeft'){ const n={...P.cur}; n.x--; if(canPlace(curCells.call({cur:n}))) P.cur=n; }
  if(e.key==='ArrowRight'){ const n={...P.cur}; n.x++; if(canPlace(curCells.call({cur:n}))) P.cur=n; }
  if(e.key==='ArrowUp'){ const n={...P.cur}; n.rot=(n.rot+1)%4; if(canPlace(curCells.call({cur:n}))) P.cur=n; }
  if(e.key==='ArrowDown'){ step(); }
  draw();
});

el('puyoStart').onclick = ()=>{ puyoReset(); spawn(); P.running=true; clearInterval(P.timer); P.timer=setInterval(step, P.speed); draw(); };

// ---------------------------
// PWA: å³å¸­ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆï¼†SWï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµï¼‰
// ---------------------------
const MANIFEST = {
  name: "è¦³æ¸¬è€…ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ",
  short_name: "è¦³æ¸¬ã‚¦ã‚£ã‚¸ã‚§",
  start_url: ".",
  display: "standalone",
  background_color: "#0b0c10",
  theme_color: "#0b0c10",
  icons: []
};
// å‹•çš„ã«data:URLã§åŸ‹ã‚è¾¼ã¿
(function(){
  const blob = new Blob([JSON.stringify(MANIFEST)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  document.getElementById('manifest-link').href = url;
})();

// æœ€å°SWï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
if ('serviceWorker' in navigator){
  const swCode = `self.addEventListener('install',e=>{e.waitUntil(caches.open('obs-widget-v1').then(c=>c.addAll(['./'])))}); self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;
  const swBlob = new Blob([swCode],{type:'text/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl);
}
</script>
</body>
</html>
